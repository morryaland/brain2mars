TARGET = @PACKAGE_NAME@@EXEEXT@
CC = @CC@
CXX = @CXX@
MKDIR = @MKDIR_P@

SRC_PATH = ./src
OBJ_PATH = ./obj

CIMGUI_DIR = ./cimgui
CIMGUI_OBJS = cimgui.o
CIMGUI_OBJS += ./imgui/imgui.o
CIMGUI_OBJS += ./imgui/imgui_draw.o
CIMGUI_OBJS += ./imgui/imgui_demo.o
CIMGUI_OBJS += ./imgui/imgui_tables.o
CIMGUI_OBJS += ./imgui/imgui_widgets.o
CIMGUI_OBJS += ./imgui/backends/imgui_impl_sdl3.o
CIMGUI_OBJS += ./imgui/backends/imgui_impl_sdlgpu3.o

SRC = $(wildcard $(SRC_PATH)/*.c)
OBJ = $(patsubst $(SRC_PATH)/%.c, $(OBJ_PATH)/%.o, $(SRC))

LIBCIMGUI = $(CIMGUI_DIR)/libcimgui.a

CFLAGS+= -I$(CIMGUI_DIR) @CFLAGS@
LDFLAGS+= -static-libstdc++ -Bstatic -lstdc++ $(LIBCIMGUI) -lm @LDFLAGS@

.PHONY: all create_folders

all: create_folders $(TARGET)

$(TARGET): $(OBJ) $(LIBCIMGUI)
	$(CC) -o $@ $(OBJ) $(CFLAGS) $(LDFLAGS)

create_folders:
	$(MKDIR) $(OBJ_PATH)

$(OBJ_PATH)/%.o: $(SRC_PATH)/%.c
	$(CC) -c -o $@ $< $(CFLAGS)

$(LIBCIMGUI):
	cd $(CIMGUI_DIR)/generator && bash ./generator.sh -c "sdl3 sdlgpu3"
	$(MAKE) -C $(CIMGUI_DIR) CXX=$(CXX) CXXFLAGS="-O2 -std=c++11 -DIMGUI_DISABLE_OBSOLETE_KEYIO=1 -DIMGUI_DISABLE_OBSOLETE_FUNCTIONS=0 -I./imgui" OBJS="$(CIMGUI_OBJS)" static

clean:
	$(MAKE) -C $(CIMGUI_DIR) OBJS="$(CIMGUI_OBJS)" clean
	rm -fr $(OBJ_PATH)/*.o $(LIBCIMGUI) $(TARGET)
